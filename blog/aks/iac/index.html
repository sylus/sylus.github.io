<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Azure Kubernetes Service (AKS) is now general availability (GA) and with that announcement a slew of longstanding issues have been addressed! Most importantly you can now leverage a custom vnet and RBAC with your cluster. These were key blockers for many organizations fully going down the AKS route as opposed to ACS Engine where you still have the master node under your purview.
Notably the AKS workflow in the Azure portal has been noticably improved and for quick one-off installations I would recommend going that route.'>
<meta name='theme-color' content='#0db7ed'>

<meta property='og:title' content='AKS: Infrastructure as Code • William Hearn'>
<meta property='og:description' content='Azure Kubernetes Service (AKS) is now general availability (GA) and with that announcement a slew of longstanding issues have been addressed! Most importantly you can now leverage a custom vnet and RBAC with your cluster. These were key blockers for many organizations fully going down the AKS route as opposed to ACS Engine where you still have the master node under your purview.
Notably the AKS workflow in the Azure portal has been noticably improved and for quick one-off installations I would recommend going that route.'>
<meta property='og:url' content='http://sylus.ca/blog/aks/iac/'>
<meta property='og:site_name' content='William Hearn'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/eca9a4ec0967837e98593484bf64424a?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='azure'><meta property='article:tag' content='AKS'><meta property='article:published_time' content='2018-07-01T06:00:00&#43;06:00'/><meta property='article:modified_time' content='2018-07-01T17:30:00&#43;06:00'/><meta name='twitter:card' content='summary'><meta name='twitter:creator' content='@william_hearn'>

<meta name="generator" content="Hugo 0.26" />

  <title>AKS: Infrastructure as Code • William Hearn</title>
  <link rel='canonical' href='http://sylus.ca/blog/aks/iac/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.cb99c271.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#0db7ed;}
</style>

</head>


<body class='page type-blog has-sidebar'>

  <div class='site'>

    <div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
    William Hearn
    </h2>
    <div class='desc'>
    Technical Architect, Cloud Engineer @ Statistics Canada
    </div>
  </header>

</section>
<section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/aks' style='font-size:1em'>AKS</a>
      </li><li>
        <a href='/tags/azure' style='font-size:1em'>Azure</a>
      </li><li>
        <a href='/tags/resume' style='font-size:1em'>Resume</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/blog/'>Blog</a>
      </li><li class='item'>
        <a href='/resume/'>Resume</a>
      </li><li class='item'>
        <a href='https://github.com/sylus/website'>Repo</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>William Hearn</p><p class='desc site-desc'>Technical Architect, Cloud Engineer @ Statistics Canada</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>AKS: Infrastructure as Code</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2018-07-01T06:00:00&#43;06:00'>2018, Jul 01</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/sylus'>William Hearn</a></span>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
2 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p>Azure Kubernetes Service (<strong>AKS</strong>) is now general availability (<strong>GA</strong>) and with that announcement a slew of longstanding issues have been addressed! Most importantly you can now leverage a custom vnet and RBAC with your cluster. These were key blockers for many organizations fully going down the AKS route as opposed to ACS Engine where you still have the master node under your purview.</p>

<p>Notably the <strong>AKS</strong> workflow in the Azure portal has been noticably improved and for quick one-off installations I would recommend going that route. Of course for production type deployments always following the infrastructure as code methodology is indeed the way to go! The following templates setup a vnet in a separate &ldquo;production&rdquo; resource group where the subnet is given to the actual <strong>AKS</strong> deployment.</p>

<ul>
<li><a href="https://github.com/govcloud/aks-iac" target="_blank">AKS ARM templates</a></li>
</ul>

<h2 id="create-vnet-resources">Create VNET resources</h2>

<p>Specify the name of your resource group that the custom virtual network resides in.</p>
export AKS_VNET_RG=network-production-rg
export AKS_VNET_LOCATION=eastus

<p>If the resouce group was not created beforehand you can simply create it now.</p>
az group create -n ${AKS_VNET_RG} \
                -l ${AKS_VNET_LOCATION}

<p>We can now instantiate the custom vnet template that will create both a local and containers subnet.</p>
az group deployment create -n aks-managed-vnet \
                           -g ${AKS_VNET_RG} \
                           --template-file kube-vnet.json \
                           --parameters kube-vnet.parameters.json

<h2 id="service-principal">Service Principal</h2>

<p>Grant the AKS cluster Service Principal access to our custom virtual network using the resource group.</p>
az ad sp create-for-rbac --name aks-sylus
az role assignment create --role=Contributor \
                          --scope=/subscriptions/<SUBSCRIPTION ID>/resourceGroups/${AKS_VNET_RG} \
                          --assignee <SP CLIENTID>

<h1 id="create-aks-cluster">Create AKS cluster</h1>

<p>In order to create a managed AKS cluster leveraging the custom vnet simply fill out the missing parameters in the <code>kube-managed.parameters.json</code> file. These parameters include but are not limited to the following:</p>

<ul>
<li>dnsPrefix</li>
<li>resourceName</li>
<li>servicePrincipalClientId</li>
<li>servicePrincipalClientSecret</li>
<li>sshRSAPublicKey</li>
<li>vnetSubnetID</li>
</ul>
export AKS_RG=aks-sylus-rg
export AKS_NAME=aks-managed-sylus
az group create -n ${AKS_RG} \
                -l ${AKS_VNET_LOCATION}
az group deployment create -n ${AKS_NAME} \
                           -g ${AKS_RG} \
                          --template-file kube-managed.json \
                          --parameters kube-managed.parameters.json

<h1 id="common-operations">Common Operations</h1>

<p>Establish the kubeconfig context and retrieve cluster configuration.</p>
export AKS_RG=aks-sylus-rg
export AKS_NAME=aks-managed-sylus
az aks get-credentials --resource-group ${AKS_RG} \
                       --name ${AKS_NAME}

<p>Similarly to <code>kubectl proxy</code> with launch and open the Kubernetes dashboard.</p>
az aks browse --resource-group ${AKS_RG} \
              --name ${AKS_NAME}

<p>Will delete the managed cluster service alongside with all its dependencies.</p>
az group delete --name ${AKS_RG}

<p>This will enable dev spaces for the deployed AKS cluster.</p>
az aks use-dev-spaces -g ${AKS_RG} \
                      -n ${AKS_NAME} \
                      -s develop/sylus -y

<!-- Links Referenced -->

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  <div class='categories'>
  <span class='taxonomy-icon'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
</span>
  <span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/aks'>AKS</a></div>
<div class='tags'>
  <span class='taxonomy-icon'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
</span>
  <span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/azure'>Azure</a>, <a class='tag' href='/tags/aks'>AKS</a></div>

  </div>
</footer>


</article>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/sylus' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/william_hearn' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:william.hearn@canada.ca' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://gitlab.com/sylus' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Gitlab account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/william-hearn-78688227' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2017-2018 Sylus </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.9daad1e6.js'></script><script src='/js/custom.js'></script>
</body>

</html>

